<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout/default">
<head>
    <meta charset="UTF-8">
    <title>채팅 서비스</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
	<style>
	/* 임시 */
.extension p,.extension>h2{
    font-weight:500;
    text-align:center
}
.button-link,.message-form,.modified{
    margin-left:auto;
    margin-right:auto
}
body{
    font-family:Cousine,monospace
}
.modified{
    width:60%
}
a{
    text-decoration:none!important;
    cursor:pointer
}
header{
    width:100%;
    height:65px;
    padding:0 10px;
    border-bottom:1px solid #ddd
}
header>span{
    font-size:22px;
    line-height:70px;
    color:#5D5D5D
}
.margin-zero {
    margin-right: 5px !important;
    margin-left: 5px !important;
}
.margin-zero > .toggle {
    margin-bottom: 20px;
    width: 100% !important;
}
.github-username{
    float:right;
    font-size:16px;
    line-height:80px
}
.extension{
    margin-top:50px;
    padding-top:30px
}
.extension>h2{
    font-size:45px;
    font-family:Lato,Helvetica Neue,Helvetica,Arial,sans-serif
}
.extension p{
    font-size:18px;
    color:#555;
    margin-top:20px
}
i{
    font-size:24px!important
}
.button-link{
    width:230px;
    margin-top:30px
}
.course{
    height:60px
}
.custom-badge-button {
    padding-top: 7px;
    padding-bottom: 7px;
    width: 110px;
}
.extension>.part{
    text-align:center;
    font-size:13px;
    color:#777;
    margin-top:8px;
    font-weight:100
}
.container{
    padding:5px!important
}
.toggle-switch{
    width:200px
}
.toggle{
    width:320px!important;
    background-color:#000
}
.toggle>.toggle-group>.btn{
    color:#fff
}
.toggle>.toggle-group>.toggle-off,.toggle>.toggle-group>.toggle-on{
    padding-left:25px
}
.toggle[disabled], .toggle[disabled] > .toggle-group > .btn{
    background-color: #AAAAAA;
    opacity: 1;
    cursor: not-allowed !important;
}
.message-form{
    width:97%;
    padding-left:3px;
    padding-right:1px;
    margin-bottom: 30px
}
.message-form .row input,footer{
    width:100%
}
.message-form .row{
    width:100%;
    padding:0!important
}
.message-form .row .col-md-2{
    padding-left:20px!important
}
#userinfo td{
    padding-left:0;
    padding-bottom:0;
    padding-top:0
}
#userinfo .time-info{
    display:inline-block;
    float:right;
    color:#aaa;
    padding-top:9px;
    font-size: 12px;
}
#userinfo .name-info{
    display:inline-block;
    padding:.75rem;
    background-color:#007bff;
    color:#fff;
    border-radius: 25px;
    padding-top: 5px;
    padding-bottom: 5px;
    margin-top: 2px;
    margin-bottom: 2px;
}
footer{
    height:100px;
    border-top:1px solid #DDD
}
.new-user-joined{
    text-align:center;
    background-color:#222;
    color:#fff;
    padding-top:10px!important;
    padding-bottom:10px!important
}
.text-footer{
    text-align:center;
    line-height:70px;
    color:#575757;
    font-size:12px
}
.text-footer>a>i{
    font-size:12px!important
}
.text-footer>a:hover{
    text-decoration:underline!important
}
@media screen and (max-width:700px){
    .modified{
        width:100%
    }
}
/*임시 끝*/
	
	
	  .container{max-width:1170px; margin:auto;}
	img{ max-width:100%;}
	.inbox_people {
	  background: #f8f8f8 none repeat scroll 0 0;
	  float: left;
	  overflow: hidden;
	  width: 40%; border-right:1px solid #c4c4c4;
	}
	.inbox_msg {
	  border: 1px solid #c4c4c4;
	  clear: both;
	  overflow: hidden;
	}
	.top_spac{ margin: 20px 0 0;}
	
	
	.recent_heading {float: left; width:40%;}
	.srch_bar {
	  display: inline-block;
	  text-align: right;
	  width: 60%; padding:
	}
	.headind_srch{ padding:10px 29px 10px 20px; overflow:hidden; border-bottom:1px solid #c4c4c4;}
	
	.recent_heading h4 {
	  color: #05728f;
	  font-size: 21px;
	  margin: auto;
	}
	.srch_bar input{ border:1px solid #cdcdcd; border-width:0 0 1px 0; width:80%; padding:2px 0 4px 6px; background:none;}
	.srch_bar .input-group-addon button {
	  background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
	  border: medium none;
	  padding: 0;
	  color: #707070;
	  font-size: 18px;
	}
	.srch_bar .input-group-addon { margin: 0 0 0 -27px;}
	
	.chat_ib h5{ font-size:15px; color:#464646; margin:0 0 8px 0;}
	.chat_ib h5 span{ font-size:13px; float:right;}
	.chat_ib p{ font-size:14px; color:#989898; margin:auto}
	.chat_img {
	  float: left;
	  width: 11%;
	}
	.chat_ib {
	  float: left;
	  padding: 0 0 0 15px;
	  width: 88%;
	}
	
	.chat_people{ overflow:hidden; clear:both;}
	.chat_list {
	  border-bottom: 1px solid #c4c4c4;
	  margin: 0;
	  padding: 18px 16px 10px;
	}
	.inbox_chat { height: 550px; overflow-y: scroll;}
	
	.active_chat{ background:#ebebeb;}
	
	.incoming_msg_img {
	  display: inline-block;
	  width: 6%;
	}
	.received_msg {
	  display: inline-block;
	  padding: 0 0 0 10px;
	  vertical-align: top;
	  width: 92%;
	 }
	 .received_withd_msg p {
	  background: #ebebeb none repeat scroll 0 0;
	  border-radius: 3px;
	  color: #646464;
	  font-size: 14px;
	  margin: 0;
	  padding: 5px 10px 5px 12px;
	  width: 100%;
	}
	.time_date {
	  color: #747474;
	  display: block;
	  font-size: 12px;
	  margin: 8px 0 0;
	}
	.received_withd_msg { width: 57%;}
	.mesgs {
	  float: left;
	  padding: 30px 15px 0 25px;
	  width: 60%;
	}
	
	 .sent_msg p {
	  background: #05728f none repeat scroll 0 0;
	  border-radius: 3px;
	  font-size: 14px;
	  margin: 0; color:#fff;
	  padding: 5px 10px 5px 12px;
	  width:100%;
	}
	.outgoing_msg{ overflow:hidden; margin:26px 0 26px;}
	.sent_msg {
	  float: right;
	  width: 46%;
	}
	.input_msg_write input {
	  background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
	  border: medium none;
	  color: #4c4c4c;
	  font-size: 15px;
	  min-height: 48px;
	  width: 100%;
	}
	
	.type_msg {border-top: 1px solid #c4c4c4;position: relative;}
	.msg_send_btn {
	  background: #05728f none repeat scroll 0 0;
	  border: medium none;
	  border-radius: 50%;
	  color: #fff;
	  cursor: pointer;
	  font-size: 17px;
	  height: 33px;
	  position: absolute;
	  right: 0;
	  top: 11px;
	  width: 33px;
	}
	.messaging { padding: 0 0 50px 0;}
	.msg_history {
	  height: 516px;
	  overflow-y: auto;
	}
	</style> 
</head>
<th:block layout:fragment="content">
    <!-- Begin Page Content -->
    <div class="container-fluid">

        <!-- Breadcrumbs-->
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="/">Dashboard</a>
            </li>
            <li class="breadcrumb-item active">채팅</li>
        </ol>
        <div class="card shadow mb-4">
<!--             <input type="text" id="nickname" class="form-inline" placeholder="닉네임을 입력해주세요" required autofocus>
	        <div class="mesgs">
	          <div id = "chatroom" class="msg_history">
	          </div>
	          <div class="type_msg">
	            <div class="input_msg_write">
	              <input type="text" id="message" class="write_msg" placeholder="Type a message" />
	              <button class="msg_send_btn" type="button" id = "send"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
	            </div>
	          </div>
	        </div> -->
            <div class="row margin-zero" style="justify-content: space-between;">
                
                <input id="toggle-chat-type" type="checkbox" data-toggle="toggle" data-off="Switch to Private chat!"
                    data-on="Switch to Public chat!" data-onstyle="primary" data-offstyle="default" data-height="40">
                
                <div id="room-code-box" class="float-right" style="display: none; height: 40px;">
                    <button id="generate-room-code" class="btn btn-warning">Room Code</button>
                </div>
            </div>

            <div id="main-content" class="container">

                <!-- public chat info -->
                <div id="public" class="row">

                    <div class="col-md-5">
                        <div class="form-group">
                            <input type="text" class="name form-control" placeholder="username..">
                        </div>
                    </div>

                    <div class="col-md-5">
                        <form class="form-inline">
                            <div class="form-group">
                                <input class="toggle-event toggle-switch" type="checkbox" data-toggle="toggle" data-off="Connect to chat!"
                                    data-on="Disconnect Please!">
                            </div>
                        </form>
                    </div>

                    <div class="col-md-2">
                        <div class="form-group">
                            <button type="button" class="btn btn-sm btn-primary custom-badge-button">
                                Hackers <span id="badge" class="badge">0</span>
                            </button>
                        </div>
                    </div>

                </div>

                <!-- public chat info -->
                <div id="private" class="row">

                    <div class="col-md-2">
                        <div class="form-group">
                            <input id="groupid" type="text" class="form-control" title="secret group code" placeholder="groupid.." name="groupid">
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            <input type="text" class="name form-control" placeholder="username.." name="username">
                        </div>
                    </div>

                    <div class="col-md-5">
                        <form class="form-inline">
                            <div class="form-group">
                                <input class="toggle-event toggle-switch" type="checkbox" data-toggle="toggle" data-off="Connect to chat!"
                                    data-on="Disconnect Please!" data-height="37.5">
                            </div>
                        </form>
                    </div>

                    <div class="col-md-2">
                        <div class="form-group">
                            <button type="button" class="btn btn-sm btn-primary custom-badge-button">
                                Hackers <span id="badge" class="badge">0</span>
                            </button>
                        </div>
                    </div>

                </div>

                <!-- to show messages -->
                <div class="row">
                    <div class="col-md-12">
                        <table id="conversation" class="table table-striped">
                            <tbody id="userinfo"></tbody>
                        </table>
                    </div>
                </div>

                <!-- input field to send messages -->
                <div class="row">
                    <form class="message-form form-inline">
                        <div class="row">
                            <div class="col-md-11">
                                <div class="form-group">
                                    <input type="text" id="message" class="form-control" placeholder="type message here.."
                                        disabled="disabled">
                                </div>
                            </div>
                            <div class="col-md-1">
                                <button id="send" class="btn btn-default" type="submit" disabled="disabled">Send</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="pageScript">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
    <script th:inline = "javascript">
    var groupid = null;
    var stompClient = null;
    var sendurl = "/app"
    var fetchurl = "/topic"
    var isPrivateModeEnabled = false;

    function getName() {
        if (isPrivateModeEnabled) {
            return $('.name:last').val()
        } else {
            return $('.name:first').val()
        }
    }

    function reset() {
        disconnect()
        $('.name').val('')
        $('#userinfo').html('')
        toogleMessageFeilds(true)
        $('#groupid').val('').attr('readonly', false)
        $('.toggle-event').each(function () {
            $(this).bootstrapToggle('off')
            $(this).bootstrapToggle('disable');
        });
    }

    function private() {
        reset();
        $('#public').hide();
        $('#private').show();
        isPrivateModeEnabled = true;
        $('#room-code-box').show()
        $(".margin-zero > .toggle").css("cssText", "width: 82.7% !important; height: 40px");
    }

    function public() {
        reset();
        groupid = null
        $('#public').show();
        $('#private').hide();
        $('#room-code-box').hide()
        isPrivateModeEnabled = false;
        $(".margin-zero > .toggle").css("cssText", "width: 100% !important;height: 40px");
    }

    function setConnected(e) {
        $('#connect').prop('disabled', e);
        $('#disconnect').prop('disabled', !e)
    }

    function connect() {
        var e = new SockJS('/websocket-example');
        stompClient = Stomp.over(e);
        groupid = $('#groupid').val()
        if(isPrivateModeEnabled) {
            sendurl = "/app/" + groupid
            fetchurl = "/topic/" + groupid
        } else {
            sendurl = "/app"
            fetchurl = "/topic"
        }

        stompClient.connect({}, function (e) {
            setConnected(!0);
            sendName();
            stompClient.subscribe(fetchurl + '/connect', function (e) {
                var n = JSON.parse(e.body);
                userAlert(n)
            }),
                stompClient.subscribe(fetchurl + '/message', function (e) {
                    var n = JSON.parse(e.body);
                    showMessage(n)
                }),
                stompClient.subscribe('/topic/stats', function (e) {
                    var n = JSON.parse(e.body);
                    updateBadge(n)
                })
        })
    }

    function disconnect() {
        null !== stompClient && stompClient.disconnect(),
            setConnected(!1);
        $('.name').attr('disabled', !1);
        $('#badge').html(0);
    }

    function sendName() {
        stompClient.send(sendurl + '/connect', {}, getName());
        $('.name').attr('disabled', !0);
    }

    function sendMessage() {
        stompClient.send(sendurl + '/message', {}, JSON.stringify({
            name: getName(),
            content: $('#message').val()
        }));
        $('#message').val('');
    }

    function updateBadge(n) {
        $('#badge').html(n);
    }

    function userAlert(e) {
        $('#userinfo').append("<tr><td class='new-user-joined'>" + e.name + " " + e.content + "</td></tr>")
    }

    function showMessage(e) {
        if (e.type === 'LEAVE') {
            $('#userinfo').append("<tr><td class='new-user-joined'>" + e.name + " " + e.content + "</td></tr>")
        } else {
            $('#userinfo').append("<tr><td><span class='name-info'>" + e.name + "</span> " + e.content + " <span class='time-info'>" + e.time + "</span></td ></tr > ")
        }
    }

    function toogleMessageFeilds(e) {
        $('#send').attr('disabled', e),
        $('#message').attr('disabled', e)
        $('#generate-room-code').attr('disabled', !e)
    }

    $(function () {
        $('#private').hide()

        $('form').on('submit', function (e) {
            e.preventDefault()
        }), 

        $(function () {
            $('.toggle-event').change(function () {
                $(this).prop('checked') ? connect() : disconnect()
                toogleMessageFeilds(!$(this).prop('checked'))
            })
        }),

        $(function () {
            $('#toggle-chat-type').change(function () {
                $(this).prop('checked') ? private() : public()
            })
        }),

        $('#send').click(function () {
            sendMessage()
        }), 

        $('.name').on('keyup', function () {
            var object = $(this).val();
            if (object.length <= 0) {
                $('.toggle-event').bootstrapToggle('disable');
            } else {
                $('.toggle-event').bootstrapToggle('enable');
            }
        }),

        $('#private input[type=text]').on('keyup', function () {

            var groupid = $('input[name=groupid]').val().length;
            var username = $('input[name=username]').val().length;

            if (groupid <= 6 || username <= 0) {
                $('.toggle-event').bootstrapToggle('disable');
            } else {
                $('.toggle-event').bootstrapToggle('enable');
            }
        }) 

        $('.toggle-event').bootstrapToggle('disable'),

        $('#generate-room-code').click(function () {
            $('#groupid').val((new Date().valueOf()).toString(36)).attr('readonly', true)
        });
    });

    </script>

</th:block>
</html>
